services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: qms
      POSTGRES_USER: qms
      POSTGRES_PASSWORD: qms
    ports:
      - "5432:5432"
    volumes:
      - qms_pgdata:/var/lib/postgresql/data

  migrate:
    image: migrate/migrate:4
    depends_on:
      - postgres
    volumes:
      - ../../services/queue-service/migrations:/migrations:ro
    command: ["-path", "/migrations", "-database", "${DB_DSN}", "up"]
    environment:
      DB_DSN: postgres://qms:qms@postgres:5432/qms?sslmode=disable

  queue-service:
    build:
      context: ../../services/queue-service
    env_file:
      - ../../.env
    environment:
      PORT: "8080"
      DB_DSN: postgres://qms:qms@postgres:5432/qms?sslmode=disable
    depends_on:
      - postgres
    ports:
      - "8080:8080"

  auth-service:
    build:
      context: ../../services/auth-service
    env_file:
      - ../../.env
    environment:
      AUTH_PORT: "8081"
      DB_DSN: postgres://qms:qms@postgres:5432/qms?sslmode=disable
    depends_on:
      - postgres
    ports:
      - "8081:8081"

  notification-service:
    build:
      context: ../../services/notification-service
    env_file:
      - ../../.env
    environment:
      NOTIF_PORT: "8082"
      DB_DSN: postgres://qms:qms@postgres:5432/qms?sslmode=disable
    depends_on:
      - postgres

  admin-service:
    build:
      context: ../../services/admin-service
    env_file:
      - ../../.env
    environment:
      ADMIN_PORT: "8083"
      DB_DSN: postgres://qms:qms@postgres:5432/qms?sslmode=disable
    depends_on:
      - postgres
    ports:
      - "8083:8083"

  analytics-service:
    build:
      context: ../../services/analytics-service
    env_file:
      - ../../.env
    environment:
      ANALYTICS_PORT: "8084"
      DB_DSN: postgres://qms:qms@postgres:5432/qms?sslmode=disable
    depends_on:
      - postgres
    ports:
      - "8084:8084"

  realtime-service:
    build:
      context: ../../services/realtime-service
    env_file:
      - ../../.env
    environment:
      REALTIME_PORT: "8085"
      DB_DSN: postgres://qms:qms@postgres:5432/qms?sslmode=disable
    depends_on:
      - postgres
    ports:
      - "8085:8085"

volumes:
  qms_pgdata:
